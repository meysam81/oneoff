name: ci

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  checks:
    permissions:
      contents: read
      pull-requests: read
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum', '**/go.mod') }}
          restore-keys: |
            ${{ runner.os }}-go-
      - name: Install frontend dependencies
        run: bun install
      - name: Build frontend
        run: bun run build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v9

  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum', '**/go.mod') }}
          restore-keys: |
            ${{ runner.os }}-go-
      - name: Install dependencies
        run: |
          go mod download
          bun install
      - name: Build frontend
        run: bun run build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./...
      - name: Upload coverage
        uses: codecov/codecov-action@v5
        with:
          files: |
            ./coverage.out
          flags: unittests
          fail_ci_if_error: false

  build:
    runs-on: ubuntu-latest
    needs: [checks, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum', '**/go.mod') }}
          restore-keys: |
            ${{ runner.os }}-go-
      - name: Install dependencies
        run: |
          go mod download
          bun install
      - name: Build frontend
        run: bun run build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Build backend
        run: |
          go build -ldflags="-s -w \
            -X main.version=dev-${{ github.sha }} \
            -X main.commit=${{ github.sha }} \
            -X main.date=$(date -u +%Y-%m-%dT%H:%M:%SZ) \
            -X main.builtBy=github-actions" \
            -trimpath \
            -o oneoff .
      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: oneoff-${{ github.run_id }}-${{ github.run_attempt }}
          path: oneoff

  release-please:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    outputs:
      releases_created: ${{ steps.release-please.outputs.releases_created }}
      tag_name: ${{ steps.release-please.outputs.tag_name }}
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - id: release-please
        name: Release please
        uses: googleapis/release-please-action@v4
        with:
          release-type: go

  goreleaser:
    needs: release-please
    if: needs.release-please.outputs.releases_created == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      issues: write
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ needs.release-please.outputs.tag_name }}
      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum', '**/go.mod') }}
          restore-keys: |
            ${{ runner.os }}-go-
      - name: Install syft
        uses: anchore/sbom-action/download-syft@v0
      - name: Install cosign
        uses: sigstore/cosign-installer@v3
      - name: Import GPG key
        if: ${{ env.GPG_PRIVATE_KEY != '' }}
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | base64 --decode | gpg --batch --import
          echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes --passphrase-fd 0 --pinentry-mode loopback --quick-add-uid "$(gpg --list-secret-keys --with-colons | awk -F: '/^sec:/ {print $5; exit}')" || true
          GPG_FINGERPRINT=$(gpg --list-secret-keys --with-colons | awk -F: '/^fpr:/ {print $10; exit}')
          echo "GPG_FINGERPRINT=$GPG_FINGERPRINT" >> "$GITHUB_ENV"
      - env:
          GITHUB_TOKEN: ${{ github.token }}
        name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          args: release --release-notes CHANGELOG.md --clean
          distribution: goreleaser
          version: ~> v2

  preview:
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./landing-page
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Cache
        uses: actions/cache@v4
        with:
          path: |
            node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('**/bun.lock', '**/package-lock.json') }}
          restore-keys: |
            node-modules-${{ runner.os }}-
      - name: Setup bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Install bun deps
        run: bun install
      - name: Build
        run: bun run build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v4
        with:
          name: build-pr${{ github.event.pull_request.number }}-${{ github.run_id }}-${{ github.run_attempt }}
          path: landing-page/dist
      - name: Deploy to Netlify
        id: netlify
        run: |
          bunx netlify-cli@v23 deploy \
            --site "$NETLIFY_SITE_ID" \
            --no-build \
            --json \
            --dir './dist' \
            --message 'pr:${{ github.event.pull_request.number }} sha:${{ github.sha }}' \
            | jq -r .deploy_url | tee deploy_url.txt
          deploy_url="$(cat deploy_url.txt)"
          echo "deploy_url=$deploy_url" >> "$GITHUB_OUTPUT"
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
      - name: Comment PR
        uses: meysam81/comment-pr@main
        with:
          title: "# Live preview"
          content: |
            The live preview of the changes are available at the following URL:
            <${{ steps.netlify.outputs.deploy_url }}>
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Lychee
        uses: lycheeverse/lychee-action@v2
        with:
          args: --verbose
          fail: false
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

  deploy-website:
    if: github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    permissions:
      contents: read
      pages: write
      id-token: write
    defaults:
      run:
        working-directory: ./landing-page
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Cache
        uses: actions/cache@v4
        with:
          path: |
            node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('**/bun.lock', '**/package-lock.json') }}
          restore-keys: |
            node-modules-${{ runner.os }}-
      - name: Setup bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Setup Pages
        uses: actions/configure-pages@v5
      - name: Install bun deps
        run: bun install
      - name: Build
        run: bun run build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - id: upload-artifact
        name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v4
        with:
          name: github-actions-${{ github.run_id }}-${{ github.run_attempt }}
          path: landing-page/dist
      - id: deployment
        name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
        with:
          artifact_name: github-actions-${{ github.run_id }}-${{ github.run_attempt }}
